# FoundationDB Integration Test Environment for Management API
# This setup provides an isolated FDB cluster for running integration tests
# NOT FOR PRODUCTION USE

services:
  # FoundationDB server (custom multi-arch build with ARM64 support)
  foundationdb:
    build:
      context: ../../
      dockerfile: docker/fdb-integration-tests/Dockerfile.fdb
    container_name: inferadb-mgmt-fdb-test
    hostname: fdb-server
    networks:
      - fdb-test-network
    ports:
      # Expose FDB port for debugging (optional)
      - "4500:4500"
    healthcheck:
      test: ["CMD-SHELL", "pgrep -x fdbserver > /dev/null && test -f /var/fdb/fdb.cluster"]
      interval: 3s
      timeout: 5s
      retries: 10
      start_period: 10s
    volumes:
      # Persist cluster configuration for the test runner
      - fdb-config:/var/fdb
    # Resource limits to prevent interference
    deploy:
      resources:
        limits:
          cpus: "2.0"
          memory: 2G
        reservations:
          cpus: "0.5"
          memory: 512M

  # Test runner
  test-runner:
    build:
      context: ../../
      dockerfile: docker/fdb-integration-tests/Dockerfile
    container_name: inferadb-mgmt-test-runner
    networks:
      - fdb-test-network
    depends_on:
      foundationdb:
        condition: service_healthy
    environment:
      # Point to the FDB server
      FDB_CLUSTER_FILE: /etc/foundationdb/fdb.cluster
      # Rust test configuration
      RUST_BACKTRACE: 1
      RUST_LOG: debug
    volumes:
      # Mount source code for development
      - ../../:/workspace:cached
      # Share FDB cluster configuration
      - fdb-config:/etc/foundationdb:ro
      # Cache cargo registry and build artifacts
      - cargo-registry:/usr/local/cargo/registry
      - cargo-git:/usr/local/cargo/git
      - target-cache:/workspace/target
    working_dir: /workspace
    # Keep container running for manual test execution
    # Override with: docker-compose run test-runner /workspace/docker/fdb-integration-tests/run-tests.sh
    command: tail -f /dev/null

networks:
  fdb-test-network:
    driver: bridge
    name: inferadb-mgmt-fdb-test-net

volumes:
  fdb-config:
    name: inferadb-mgmt-fdb-config
  cargo-registry:
    name: inferadb-mgmt-cargo-registry
  cargo-git:
    name: inferadb-mgmt-cargo-git
  target-cache:
    name: inferadb-mgmt-target-cache
