# Custom FoundationDB Docker Image with ARM64 Support
# This builds a multi-arch FDB image that works on both amd64 and arm64
# Based on official FDB but using native ARM64 binaries when available

FROM debian:bookworm-slim

# Install required dependencies
RUN apt-get update && apt-get install -y \
    wget \
    ca-certificates \
    python3 \
    procps \
    && rm -rf /var/lib/apt/lists/*

# Set FDB version
ENV FDB_VERSION=7.3.69

# Detect architecture and download appropriate FDB packages
# Note: FDB uses _aarch64 naming for ARM64, not _arm64
ARG TARGETARCH
RUN echo "Building for architecture: ${TARGETARCH}" && \
    if [ "$TARGETARCH" = "arm64" ]; then \
        echo "Using ARM64 binaries (aarch64 naming)" && \
        wget -q https://github.com/apple/foundationdb/releases/download/${FDB_VERSION}/foundationdb-clients_${FDB_VERSION}-1_aarch64.deb -O /tmp/fdb-clients.deb && \
        wget -q https://github.com/apple/foundationdb/releases/download/${FDB_VERSION}/foundationdb-server_${FDB_VERSION}-1_aarch64.deb -O /tmp/fdb-server.deb; \
    else \
        echo "Using AMD64 binaries" && \
        wget -q https://github.com/apple/foundationdb/releases/download/${FDB_VERSION}/foundationdb-clients_${FDB_VERSION}-1_amd64.deb -O /tmp/fdb-clients.deb && \
        wget -q https://github.com/apple/foundationdb/releases/download/${FDB_VERSION}/foundationdb-server_${FDB_VERSION}-1_amd64.deb -O /tmp/fdb-server.deb; \
    fi && \
    dpkg -i /tmp/fdb-clients.deb /tmp/fdb-server.deb || (apt-get update && apt-get install -f -y) && \
    rm /tmp/fdb-clients.deb /tmp/fdb-server.deb && \
    ldconfig

# Create FDB data directories
RUN mkdir -p /var/fdb/data /var/fdb/logs && \
    chown -R foundationdb:foundationdb /var/fdb

# Copy startup script
COPY docker/fdb-integration-tests/fdb-entrypoint.sh /usr/local/bin/
RUN chmod +x /usr/local/bin/fdb-entrypoint.sh

# Expose FDB port
EXPOSE 4500

# Set working directory
WORKDIR /var/fdb

# Use our custom entrypoint
ENTRYPOINT ["/usr/local/bin/fdb-entrypoint.sh"]
